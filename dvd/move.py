
# 						  nb_total_area
# 			       nb_Layer   | nb_Sublayer
# 	 size     version  |      |    |
# L00 426637   01000000 0400 [ 6d00 0100 [ 0400   fe09 3f06   0000 3f06   0000 0000   fe09 0000 ] 2d00540820056408eb03c0063e031608650356068b041505b2030a018b010200360158068b046205c2046307ee03c407f802d305ad0499058b03d1026a0529030b05d101c0018602
# L01 258203   01000000 0300 [ 4800 0100 [ 0400   0000 0000   3f08 0000   3f08 3f04   0000 3f04 ] 14009703a70025027f009600d801980128017e040b039b0619034903e403bd04e0026205dc0269065e030807a903b60710049a05ff019e06a001ab06b4018c07220376073d043107
# L02 292260   01000000 0300 [ 7500 0100 [ 0400   0000 0000   3f06 0000   3f06 3f09   0000 3f09 ] 15003104e3004f03c90085032f02b1042702e201df07bb04d7083e06b1079a04cd0889011f083f040509f802710256032e02410286001d0387004002860129035e01b60228018201
# L03 40445    01000000 0300 [ 0a00 0100 [ 0400   0000 0000   7f07 0000   7f07 7f03   0000 7f03 ] 02002b062202dc062502ed014b026b037f010900040069010c015d01fa007201f00084010401040093015c01ae014f01c5015e01ad0164010600bd011101ef0106010d021701f701
# L04 316178   01000000 0300 [ 5b00 0100 [ 0400   0000 0000   ff09 0000   ff09 7f05   0000 7f05 ] 25008b03df01b104cb014e04f402560503030005b502790419039802a701ef035e02e004ad0332066e03f705a304600706056c041e02d703830126087f05de06c904810572048604
# L05 16353    01000000 0200 [ 0700 0300 [ 0500   5104 0300   fc04 0300   fc04 1601 fc03 fa00 fc03b700000000000d0018018601fd007b01df007a01c8008101b8006901dc005f01cb004d01d8004d01f300530104014e01070168012a0177012c017f010000000064000000fc00
# L06 306387   01000000 0400 [ 4c00 0200 [ bd00   3d09 3a01   6d07 2d02   8307 3b02 2e07 6b02 ee06410252068d02610695024906ae02f80585028d05c3029705b30234059a021a05ba028005d5028a05c802b705de02db044403b5042f0398044103dc047103e7046b0315058b03
# L07 267175   01000000 0300 [ 4d00 0100 [ 0400   0000 0000   3f08 0000   3f08 3f04 0000 3f04 15009703a70025027f009600d801980128014903e403bd04e0026205dc026a065d030407a403b60710049b050002a3069a01ab06b4018c07220376073d04310743036c0490022305
# L08 269066   01000000 0400 [ 4400 0200 [ 1900   4005 9003   7805 8503   c405 6903 a905 4f03 9606f402e6054a02260631023a0645029c06220297061a02c7060902cf0611022e07ea011d07db019f07ac01b607c101c807b801b407a701dd079701be086f02be08b5021706b403
# L09 88420    01000000 0300 [ 1e00 0200 [ 1c00   d002 0a01   b502 ec00   bc02 cd00 dc02 cf00 0103b9003603c30066037400b803a3001e0497006f04c800c004bd002b044801280451011f04530118045a01160462010f0462010904690105047101ff037101f1037d01e4036901
# L10 191129   01000000 0900 [ 2900 0300 [ 0300   3b03 a404   3603 a404   3903 a004 0000 0000 4e003802a00459029e0486028204e5029d04e102a804fa02a3045603b9044f03c3047c03cf048e03c5047c03b904c1036204fb037304de03a4042e04b404c503d004a30304056b03
# L11 143742   01000000 0400 [ 1000 0200 [ 2000   2c02 3201   0602 4301   cd01 3001 d501 1601 aa01b800ae01ac009e019a009b018500ac018500cf016d00f1014900b001680039018400f0006100af013400df011c00cd01000022030000fd024d00f6028a00dd02a600b302b100
# L12 303131   01000000 0500 [ 5400 0100 [ 0400   0000 0000   bf08 0000   bf08 bf06 0000 bf06 1b008403fe03ad0479024c06e2026d044604840329025e0602037200ad01a900d802f6054a0107087f003107bf06de07d40588032502f502bf03e900f8005e01f3028301bf041d03
# L13 103845   01000000 0500 [ 1a00 0400 [ 1800   0000 fc02   2f00 1303   4900 0b03 6500 1703 4a003c038c004f03a6008b038600890375009c03ad009a03e4001104cd001d04e4005704000152042b01bf041b01d1043701d504570127053d0130054601470532014d056800ef05
# L14 214341   01000000 0600 [ 2b00 0200 [ 7000   3802 6001   5902 5e01   8902 4301 9902 4801 8a025b0195026a01ac026401bb025101e7025d01e1026801fb02630119036a012e0363014b03690148037601560379014f0383017c038f018e0385017c037901b3033601f7034901
# L15 388316   01000000 0400 [ 6a00 0300 [ 2b00   0000 5000   6000 6c00   9000 9d00 a800 c800 d500e00049015601aa008f01b8009a01c700ac01a300c301c800e101ee00d301f900da017d01ae018a01b3019401a80193024f01ba0241010803340122033e013c03360159034101
# L16 387351   01000000 0400 [ 6a00 0300 [ 3100   ba03 5601   7303 2a01   1003 2501 bf02 3d01 af023601b9023f0192024d019a023b0189024f0143026701e9010f0144014701e200e4000601df000301ce00a60072007e007f00000003009401020086011c008d012e007d013a00
# L17 82707    01000000 0500 [ 0b00 0100 [ 0400   0000 0000   3f06 0000   3f06 ff03 0000 ff03 0e005303e00112052c02b802a002550324037f009402780256028f040500e804c90042022801930073033806140102045b018104bb02b304220101050502f0021003d703dd01ea02
# L18 361416   01000000 0400 [ 6a00 0100 [ 0400   0000 0000   ff09 0000   ff09 bf06 0000 bf06 2500b502e505270422056d012805cb02f10594082903fd099f020503cf046e028d04000439053103ec045707580144089900e308d0039b088d049d074f03ec068903c7047c05e503
# L19 104355   01000000 0c00 [ 2400 0100 [ 0400   0000 0000   ff04 0000   ff04 bf08 0000 bf08 16001d01bb08230266070005d007c502560892040d05fd04c5035d046b069503750600051105c3038b04000056062e01d10573030f0705030c074e032c072803f40615011805ec01
# L20 25093    01000000 0200 [ 0800 0100 [ 0400   0000 0000   ff04 0000   ff04 ff02 0000 ff02 090000009f027701fd01d500c30106005c016702bb019d029d007f019d010300a9001b03030119027801b8023400da00460142010c02f8027702fe04370200046802f8034f02f004
# L21 471887   01000000 0400 [ 7600 0200 [ 2300   3105 0100   4105 3200   3405 5b00 4305 7b00 4505a9001e05c7000705d3000905ec00ec04f200e904ff00f0040e01d7041401c80403017304e600e204db009f04a0005704b8006d0417014d040801f603f000bd03ee009403d800
# L22 197143   01000000 0400 [ 2d00 0200 [ 3e00   9c05 8306   8d05 8e06   7705 a806 3405 b906 0805b006f0049e06b104a0067604a0060404af06a903a706790386066f03790679036b064d035606420346062e03400625033506c1020d066a02e7050202ac05c9017705aa016b05
# L23 153589   01000000 0600 [ 1800 0100 [ 0400   0000 0000   7f09 0000   7f09 3f07 0000 3f07 0c00730205034701c3034603ad02860481034d033a0429010403be028f048b0487035600b904ca022706c3038f0609034e06d0057506c3038f06fa079605c10593060a087205ce05
# L24 76292    01000000 0700 [ 1500 0a00 [ 4600   3003 d301   5503 d201   6003 ec01 4003 5c02 3b0394022703ae022d03f002520311037603f6026d03d5025703ca026203bf029603d102b303b702b1039702c7038202b5036202dd035602f3033d021b042e022804170246042102
# L25 10773    01000000 0200 [ 0500 0200 [ 3100   b701 7502   a501 7902   4901 6b02 0001 3302 f8001d029c00e301c600c601d400c701ee00c3011001ac010f01a6017f017801a3016e019c016601c2015c01b8017401d9017501e3015f01f4015d010d0266010a02710131027f01
# 
# 
# 																								     nbsub L0
# 					  [           same            ]                                              nb L   |                                                       i
# L00 420323   03000000 c040 0000 4040 0000 3041 0000 c040 0000                     9841 0000 3041  0400 0100 6d00   0000        0400 0300 0c 0c 0c    7203 2a02 fb ff f3 ff c4 ff 08 00   1900   0000 0100 0200 0300 0400 0500 0600 0700 0800 0900 0a00 0b00 0c00 0d00 0e00 0f00 1000 1100 1200 1300 1400 1500 1600 1700 1800                                                0300 09 08 08    5c03 1602 57 00 f6 ff ef ff f9 ff   0e00 1900 1a00 1b00 1c00 1d00 1e00 1f00 2000
# L01 254585   03000000 c040 0000 4040 0000 3041 0000 c040 0000                     9841 0000 3041  0300 0100 4800   0000        0500 0300 03 03 01    bd03 5d01 31 00 19 00 0b 00 f3 ff   2100   0000 0100 0200 0300 0400 0500 0600 0700 0800 0900 0a00 0b00 0c00 0d00 0e00 0f00 1000 1100 1200 1300 1400 1500 1600 1700 1800 1900 1a00 1b00 1c00 1d00 1e00 1f00 2000        0300 02 02 00    ee03 7601 2b 00 24 00 31 00 19 00   0900
# L02 289114   03000000 c040 0000 4040 0000 3041 0000 c040 0000                     9841 0000 3041  0300 0100 7500   0000        0400 0300 03 03 03    c200 c508 0f 00 07 00 2c 00 e5 ff   0e00   0000 0100 0200 0300 0400 0500 0600 0700 0800 0900 0a00 0b00 0c00 0d00                                                                                                       0300 06 06 06    d100 cc08 d5 ff 1c 00 0f 00 07 00   1000 0e00 0f00 1000 1100 1200 1300 1400 1500 1600 1700 1800 1900 1a00 1b00 1c00 1d00 0300 0c0c 0ca6
# L03 39465    03000000 c040 0000 4040 0000 3041 0000 c040 0000                     9841 0000 3041  0300 0100 0a00   0000        0400 0300 06 06 06    8401 0401 e5 ff 08 00 12 00 14 00   0800   0000 0100 0200 0300 0400 0500 0600 0700                                                                                                                                     0300 0c 0c 04    6901 0c01 f4 ff ee ff e5 ff 08 00   0d00 0800 0900 0a00 0b00 0c00 0d00 0e00 0f00 1000 1100 1200 1300 1400 0300 0909 015d 01fa 0015 00f6 fff4 ffee ff06 0015 0016 0017
# L04 312108   03000000 c040 0000 4040 0000 3041 0000 c040 0000                     9841 0000 3041  0300 0100 5b00   0000        0400 0300 03 03 02    3e04 6e02 0b 00 04 00 20 00 ee ff   1f00   0000 0100 0200 0300 0400 0500 0600 0700 0800 0900 0a00 0b00 0c00 0d00 0e00 0f00 1000 1100 1200 1300 1400 1500 1600 1700 1800 1900 1a00 1b00 1c00 1d00 1e00                  0300 06 06 06    4904 7202 df ff 13 00 0b 00 04 00   1200 1f00 2000
# L05 15753    03000000 c040 0000 4040 0000 3041 0000 c040 0000                     9841 0000 3041  0200 0300 0100   0000 0100   0500 0300 08 08 00    0701 6801 fd ff e6 ff dd ff f1 ff   0100   0000                                                                                                                                                                        0300 0c 08 00    f300 5301 e5 ff fa ff ef ff 05 00   0200 0100 0200 0300 0606 04dc 005f 01dc ff0a 0011 0012 0001 0003 0003 0003 0302 df00 7a01 1e00 0100 1700 f9ff 0100 0400 0300 0202 00fd 007b 011b 000b 001e 0001
# L06 302643   03000000 c040 0000 4040 0000 3041 0000 c040 0000                     9841 0000 3041  0400 0200 4b00               5800 0300 04 04 04    8008 2d01 b7 ff 1b 00 f0 ff 26 00   0300   0000 0100 0200                                                                                                                                                              0300 0c 0c 0c    3708 4801 bc ff ec ff b7 ff 1b 00   0200 0300 0400 0300 0606 060e 0876 017d ff37 002f 001d 0008 0005 0006 0007 0008 0009 000a 000b 000c 0003 000d 0d0d 8b07 ad01 7900 c8ff 7dff 3700 0b00 0d00 0e00
# L07 263775   03000000 c040 0000 4040 0000 3041 0000 c040 0000                     9841 0000 3041  0300 0100 4d00   0000        0500 0300 03 03 01    cd03 6801 21 00 0e 00 0e 00 f5 ff   1000   0000 0100 0200 0300 0400 0500 0600 0700 0800 0900 0a00 0b00 0c00 0d00 0e00 0f                                                                                               0300 02 02 00    ee03 7601 2b 00 24 00 21 00 0e 00   0900 1000 1100 1200 1300 1400 1500 1600 1700 1800 0300 0e0e 0e19 049a 01d5 ffe9 ff2b 0024
# L08 265138   03000000 c040 0000 4040 0000 3041 0000 c040 0000                     9841 0000 3041  0400 0200 0b00               0a00 0300 03 03 02    de05 7f03 39 00 35 00 4d 00 e6 ff   0300   0000 0100 0200                                                                                                                                                              0300 06 06 04    c807 b801 ee ff 09 00 14 00 11 00   0900 0300 0400 0500 0600 0700 0800 0900 0a00 0b00 0300 0c0c 0cb6 07c1 01e9 ffeb ffee ff09 0006 000c 000d 000e 000f 0010 0011 0003 0006 0604 2e07 ea01 a1ff 2700
# L09 86774    03000000 c040 0000 4040 0000 3041 0000 c040 0000                     9841 0000 3041  0300 0200 0100               0e00 0300 02 02 02    5c03 3b01 38 00 1e 00 8c 00 31 00   0300   0000 0100 0200                                                                                                                                                              0300 02 02 02    9d03 5d01 05 00 07 00 09 00 04 00   0300 0300 0400 0500 0300 0202 02ac 0362 012e 0010 000a 00fe ff03 0006 0007 0008 0003 0003 0300 e403 6901 0d00 1400 0a00 f7ff 0500 0900 0a00 0b00 0c00 0d00 0300
# L10 187745   03000000 c040 0000 4040 0000 3041 0000 c040 0000                     9841 0000 3041  0900 0300 0100   0000 0a00   2300 0300 02 02 02    6402 ff04 29 00 15 00 5e 00 22 00   0300   0000 0100 0200                                                                                                                                                              0300 02 02 02    8d02 1405 12 00 0e 00 29 00 15 00   0500 0300 0400 0500 0600 0700   0300 0202 029f 0222 0500 001e 0012 000e 0008 0008 0009 000a 000b 000c 000d 000e 000f 0003 000c 0c0c 9f02 4005 f6ff f2ff
# L11 140046   03000000 c040 0000 4040 0000 3041 0000 c040 0000                     9841 0000 3041  0400 0200 0200               0e00 0300 09 09 09    2902 0501 0c 00 de ff fd ff d3 ff   0100   0000                                                                                                                                                                        0300 03 03 03    3502 e300 32 00 04 00 0c 00 de ff   0500 0100 0200 0300 0400 0500 0300 0909 0970 02be 0024 00e1 fffa ffe6 ff04 0006 0007 0008 0009 0003 0009 0101 9202 9500 0f00 f4ff feff f6ff 0500 0a00 0b00 0c00 0d00 0e00
# L12 297527   03000000 c040 0000 4040 0000 3041 0000 c040 0000                     9841 0000 3041  0500 0100 5400   0000        0400 0300 0c 0c 0c    9805 a001 ec ff eb ff e2 ff 02 00   0900   0000 0100 0200 0300 0400 0500 0600 0700 0800                                                                                                                                0300 09 09 08    8405 8b01 2d 00 fd ff ec ff eb ff   1000 0900 0a00 0b00 0c00 0d00 0e00 0f00 1000 1100 1200 1300 1400 1500 1600 1700 1800 0300 0303 03b1 0588 0105 0016 002d 00fd
# L13 100409   03000000 c040 0000 4040 0000 3041 0000 c040 0000                     9841 0000 3041  0500 0400 0200               0a00 0300 09 09 09    6800 ef05 ca 00 5e ff d6 ff d9 ff   0700   0000 0100 0200 0300 0400 0500 0600                                                                                                                                          0300 01 01 00    3201 4d05 14 00 fa ff ca 00 5e ff   0200 0700 0800 0300 0909 013d 0130 051a 00f7 fff7 ffe9 ff05 0009 000a 000b 000c 000d 0003 0009 0909 1b01 d104 1000 eeff e4ff fcff 0600 0e00
# L14 211705   03000000 c040 0000 4040 0000 3041 0000 c040 0000                     9841 0000 3041  0600 0200 0600               3500 0300 02 02 02    6402 bf01 29 00 15 00 5e 00 22 00   0300   0000 0100 0200                                                                                                                                                              0300 02 02 02    8d02 d401 12 00 0e 00 29 00 15 00   0500 0300 0400 0500 0600 0700 0300 0202 029f 02e2 0100 001e 0012 000e 0005 0008 0009 000a 000b 000c 0003 000c 0c0c 9f02 0002 f7ff f0ff 0000 1e00 0600 0d00 0e00
# L15 383376   03000000 c040 0000 4040 0000 3041 0000 c040 0000                     9841 0000 3041  0400 0300 4b00               1100 0300 07 07 06    0707 2302 db ff 0d 00 23 00 f8 ff   2200   0000 0100 0200 0300 0400 0500 0600 0700 0800 0900 0a00 0b00 0c00 0d00 0e00 0f00 1000 1100 1200 1300 1400 1500 1600 1700 1800 1900 1a00 1b00 1c00 1d00 1e00 1f00 2000 2100   0300 0c 0c 04    e206 3002 f4 ff fa ff db ff 0d 00   0800
# L16 382477   03000000 c040 0000 4040 0000 3041 0000 c040 0000                     9841 0000 3041  0400 0300 0f00               1800 0300 0c 0c 08    5304 9600 b1 ff ae ff e6 ff 07 00   0700   0000 0100 0200 0300 0400 0500 0600                                                                                                                                          0300 08 08 08    ed03 3f00 f2 ff e8 ff e9 ff fb ff   0400 0700 0800 0900 0a00 0300 0909 019d 0325 0033 00db ffbe fffe ff0b 000b 000c 000d 000e 000f 0010 0011 0012 0013 0014 0015 0003 0003 0300
# L17 80799    04000000 c040 0000 4040 0000 3041 0000 c040 0000 4040 0000 0040 0000 9841 0000 3041  0500 0100 0b00   0000        0300 0400 0c 0c 0c 0c c205 8100 f3 ff fb ff fc ff 08 00   0e00   0000 0100 0200 0300 0400 0500 0600 0700 0800 0900 0a00 0b00 0c00 0d00                                                                                                       0400 09 08 09 00 b505 7c00 11 00 fd ff f3 ff fb ff   0b00 0e00 0f00 1000 1100 1200 1300 1400 1500 1600 1700 1800 0400 0704 0700
# L18 355978   03000000 c040 0000 4040 0000 3041 0000 c040 0000                     9841 0000 3041  0400 0100 6a00   0000        0300 0300 0c 0c 0c    6c08 2500 f9 ff fc ff fb ff 06 00   0800   0000 0100 0200 0300 0400 0500 0600 0700                                                                                                                                     0300 09 09 09    6508 2100 0c 00 fe ff f9 ff fc ff   0600 0800 0900 0a00 0b00 0c00 0d00 0300 0707 0771 081f 00fb ff06 000c 00fe ff05 000e 000f 0010 0011 0012 0003 0003 000b 0b03 1109
# L19 100827   02000000 c040 0000 4040 0000 3041 0000 c040                                          0c00 0100 2400   0000        0300 0200 03 03       db04 1606 0b 00 09 00 01 00 ec ff   0a00   0000 0100 0200 0300 0400 0500 0600 0700 0800 0900                                                                                                                           0200 06 06       e604 1f06 f4 ff 0b 00 0b 00 09 00   0700 0a00 0b00 0c00 0d00 0e00 0f00 1000 0200 0d0d da04 2a06 0100 ecff f4ff 0b00 0600 1100 1200 1300 1400 1500 1600 0400 0200 0606 8403 d404 f3ff
# L20 24471    04000000 c040 0000 4040 0000 3041 0000 c040 0000 4040 0000 0040 0000 9841 0000 3041  0200 0100 0800   0000        0300 0400 0c 0c 0c 0c 8c03 8101 f6 ff f9 ff f7 ff 06 00   0700   0000 0100 0200 0300 0400 0500 0600                                                                                                                                          0400 0b 0b 0b 0b 8203 7a01 13 00 01 00 f6 ff f9 ff   0d00 0700 0800 0900 0a00 0b00 0c00 0d00 0e00 0f00 1000 1100 1200 1300 0400 0606 0606 9503 7b01 f7ff 0600 1300
# L21 466151   04000000 c040 0000 4040 0000 3041 0000 c040 0000 4040 0000 0040 0000 9841 0000 3041  0400 0200 0500               1100 0400 06 04 06 00 b904 0800 6f ff 55 00 0c 00 08 00   0a00   0000 0100 0200 0300 0400 0500 0600 0700 0800 0900                                                                                                                           0400 0c 0c 0c 08 2804 5d00 db ff fc ff 6f ff 55 00   0a00 0a00 0b00 0c00 0d00 0e00 0f00 1000 1100 1200 1300 0400 0909 0908 0304 5900 0c00 f2ff dbff fcff
# L22 194103   04000000 c040 0000 4040 0000 3041 0000 c040 0000 4040 0000 0040 0000 9841 0000 3041  0400 0200 0100               1d00 0400 04 04 04 00 5b05 9b06 ea ff 09 00 f7 ff 15 00   0200   0000 0100                                                                                                                                                                   0400 04 00 04 00 4505 a406 df ff 01 00 ea ff 09 00   0200 0200 0300 0400 0c0c 0c00 2405 a506 e6ff f7ff dfff 0100 0300 0400 0500 0600 0400 0800 0800 0a05 9c06 f4ff f0ff e6ff f7ff 0100 0700 0400
# L23 149541   04000000 c040 0000 4040 0000 3041 0000 c040 0000 4040 0000 0040 0000 9841 0000 3041  0600 0100 1800   0000        0400 0400 0c 0c 0c 0c 7406 8c06 d3 ff fc ff fd ff 07 00   0d00   0000 0100 0200 0300 0400 0500 0600 0700 0800 0900 0a00 0b00 0c00                                                                                                            0400 09 08 09 08 4706 8806 05 00 f9 ff d3 ff fc ff   0400 0d00 0e00 0f00 1000 0400 0302 0300 4c06 8106 2b00 0400 0500 f9ff 0600 1100
# L24 73340    03000000 c040 0000 4040 0000 3041 0000 c040 0000 4040 0000 0040                      0700 0a00 0300               2000 0300 06 06 06    3703 fc01 eb ff 11 00 0d 00 0f 00   0300   0000 0100 0200                                                                                                                                                              0300 06 06 06    2a03 3a02 e7 ff 0c 00 08 00 2d 00   0400 0300 0400 0500 0600 0300 0604 0618 034b 02f6 ff17 0007 0005 0003 0007 0008 0009 0003 0004 0404 0c03 8502 ecff 0400 feff 2300 0200 0a00 0b00 0300 0101 01d0
# L25 10369    02000000 c040 0000 4040 0000 3041 0000 c040                                          0200 0200 0100               1600 0200 08 08       5501 4a02 e2 ff dc ff b1 ff e8 ff   0200   0000 0100                                                                                                                                                                   0200 08 08       3701 2602 f0 ff e6 ff e2 ff dc ff   0200 0200 0300 0200 0808 2701 0c02 ffff eeff f0ff e6ff 0300 0400 0500 0600 0200 0909 2601 fa01 1e00 f0ff ffff eeff 0400 0700 0800 0900 0a00 0200 0303 4401 ea01 1400 0d00 1e00 f0ff 0200 0b00
# 
# 
# read by Section
# MOVE 								String 4
# size 								UInt 4
# data 								Bytes *size
#
# data structure read by Motion
# version 							UInt 4
# nb_layer 							UShort 2
# [layer_list]						Layer *nb_layer
# 	Layer:
# 	total_area						UShort 2
# 	nb_sublayer						UShort
# 	[sublayer_list]					SubLayer *nb_sublayer
# 		Sublayer:
# 		allowed_area 				Area
# 		nb_segment 					UShort
# 		[segment_list] 				Segment *nb_segment
# 		nb_area 					UShort
# 		[disallowed_area_list]		Area *nb_area


from PyQt6.QtCore import QPointF
from PyQt6.QtGui import QPolygonF, QPainterPath

from common import *

from .section import Section, section_list
from debug import hs_to_i, i_to_hsi


class MoveArea(object):
    def __init__(self, area, crossing_point_list=None):
        self.area = area
        if crossing_point_list is None:
            self.crossing_point_list = []
        else:
            self.crossing_point_list = crossing_point_list

    def set_crossing_point_list(self, crossing_point_list):
        self.crossing_point_list = crossing_point_list

    def QPolygonF(self):
        return QPolygonF([QPointF(p.x + 0.5, p.y + 0.5) for p in self.area.coor_list])

class Sublayer(ReadableFromStream):

    def __init__(self, area_list, segment_list):
        self.area_list = [MoveArea(area) for area in area_list]
        self.segment_list = segment_list
        # self.crossing_point_list_list = []

    def __iter__(self):
        return iter(self.area_list)

    def __getitem__(self, item):
        return self.area_list[item]

    def __len__(self):
        return len(self.area_list)

    @classmethod
    def from_stream(cls, stream):
        main_area = stream.read(Area)
        nb_segment = stream.read(UShort)
        segment_list = [stream.read(Segment) for _ in range(nb_segment)]
        nb_sub_area = stream.read(UShort)
        sub_area_list = [stream.read(Area) for _ in range(nb_sub_area)]
        return cls([main_area] + sub_area_list, segment_list)

    def QPainterPath(self):
        positive = QPainterPath()
        positive.addPolygon(self.area_list[0].QPolygonF())
        positive.closeSubpath()
        for move_area in self.area_list[1:]:
            negative = QPainterPath()
            negative.addPolygon(move_area.QPolygonF())
            negative.closeSubpath()
            positive -= negative
        return positive  # positive.subtracted(negative)


class Layer(ReadableFromStream):
    def __init__(self, total_area, sublayer_list):
        self.total_area = total_area
        self.sublayer_list = sublayer_list
        # self.movable_mask = None

    def __iter__(self):
        return iter(self.sublayer_list)

    def __getitem__(self, item):
        return self.sublayer_list[item]

    def __len__(self):
        return len(self.sublayer_list)

    @classmethod
    def from_stream(cls, stream):
        total_area = stream.read(UShort)
        nb_sublayer = stream.read(UShort)
        sublayer_list = [stream.read(Sublayer) for _ in range(nb_sublayer)]
        return cls(total_area, sublayer_list)

    # def build(self, width, height):
    #     self.movable_mask = Mask(width, height, False)
    #     self.movable_mask.build()
    #     for sublayer in self.sublayer_list:
    #         self.movable_mask.allow(sublayer.allowed_area)
    #         for disallowed_area in sublayer.disallowed_area_list:
    #             self.movable_mask.disallow(disallowed_area)


class CrossingPoint(ReadableFromStream):

    def __init__(self, b0, coor, b1, link_path_index_list):
        self.b0 = b0
        self.coor = coor
        self.b1 = b1
        self.link_path_index_list = link_path_index_list

    @classmethod
    def from_stream(cls, stream):
        nb_bytes = stream.read(UShort)  # re_W
        b0 = [stream.read(UChar) for _ in range(nb_bytes)]
        coor = stream.read(Coordinate)
        b1 = [stream.read(UChar) for _ in range(8)]
        nb_link_path = stream.read(UShort)
        link_path_index_list = [stream.read(UShort) for _ in range(nb_link_path)]
        return cls(b0, coor, b1, link_path_index_list)


class LinkPath(ReadableFromStream):

    def __init__(self, indexes_1, indexes_2, unk1, unk2, objectC_index_list):
        self.indexes_1 = indexes_1
        self.indexes_2 = indexes_2
        self.unk1 = unk1
        self.unk2 = unk2
        self.objectC_index_list = objectC_index_list

    @classmethod
    def from_stream(cls, stream):
        indexes_1 = tuple(stream.read(UShort) for _ in range(4))
        indexes_2 = tuple(stream.read(UShort) for _ in range(4))
        unk1 = stream.read(UShort)
        unk2 = stream.read(UShort)
        objectC_index_list_length = stream.read(UShort)  # re_W
        objectC_index_list = [stream.read(UShort) for _ in range(objectC_index_list_length)]
        return cls(indexes_1, indexes_2, unk1, unk2, objectC_index_list)


class Motion(Section):
    section = section_list[2]  # MOVEef

    def __iter__(self):
        return iter(self.layer_list)

    def __getitem__(self, item):
        return self.layer_list[item]

    def __len__(self):
        return len(self.layer_list)

    def _build(self):
        version = self._stream.read(UInt)
        assert version == 1

        nb_layer = self._stream.read(UShort)
        self.layer_list = [self._stream.read(Layer) for _ in range(nb_layer)]

        W = self._stream.read(UShort)
        self._stream.read(Padding, 2)
        self.empty_flag = []
        while True:
            flag = self._stream.read_raw(2)
            nb_layer = self._stream.read(UShort)
            if nb_layer == 0:
                self.empty_flag.append(flag)
                continue
            else:
                self.active_flag = flag
                # print("layer ", end='')
                assert nb_layer == len(self.layer_list)
                for layer in self:
                    # print(f"\n     ----- {layer_index=} -----\n          ", end='')
                    nb_sublayer = self._stream.read(UShort)
                    # print("sublayer ", end='')
                    assert nb_sublayer == len(layer)
                    for sublayer in layer:
                        # print(f"\n          ----- {sublayer_index=} -----\n               ", end='')
                        nb_area = self._stream.read(UShort)
                        # print("area ", end='')
                        assert nb_area == len(sublayer)
                        for area in sublayer:
                            # print(f"\n               ----- {area_index=} -----\n                    ", end='')
                            nb_crossing_point = self._stream.read(UShort)
                            area.set_crossing_point_list([self._stream.read(CrossingPoint) for _ in range(nb_crossing_point)])
                            # last_index_read = self.layer_list[layer_index].sublayer_list[sublayer_index].a_list[-1].objectB_index_list[-1]

                # print(f"\n     ", end='')
                nb_link_path = self._stream.read(UShort)
                self.link_path_list = [self._stream.read(LinkPath) for _ in range(nb_link_path)]

                nb_objectD = self._stream.read(UShort)
                self._stream.read_raw()  # must read list of objectD TODO
                break

    # def disallow_QPolygonF(self, layer_index, sublayer_index):
    #     return [QPolygonF(
    #         [QPointF(p.x + 0.5, p.y + 0.5) for p in area.coor_list])
    #         for area in self.layer_list[layer_index].sublayer_list[sublayer_index].sub_area_list]

    def print(self):
        for i, layer in enumerate(self.layer_list):
            print(f"Layer {i_to_hsi(i)}")
            print(f"  total_area={i_to_hsi(layer.total_area)}")
            for j, sublayer in enumerate(layer.sublayer_list):
                print(f"  Sublayer {i_to_hsi(j)}")
                print(f"    nb_point_in_allow_area = {i_to_hsi(len(sublayer.main_area.coor_list))}")
                print(f"    nb_segment={i_to_hsi(len(sublayer.segment_list))}")
                print(f"    nb_disallowed_area={i_to_hsi(len(sublayer.sub_area_list))}")
                for disallowed_area in sublayer.sub_area_list:
                    print(f"      nb_point_in_disallow_area = {i_to_hsi(len(disallowed_area.coor_list))}")

    def get_ObjectA(self, indexes):
        return self.layer_list[indexes[0]].sublayer_list[indexes[1]].crossing_point_list_list[indexes[2]][indexes[3]]
